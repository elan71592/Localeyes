<div class="container">
  <h1><%= @trip.name %></h1>
  <div id="trip-map"></div>

  <div class="chip">
      <% @trip.tags.each do |tag| %>
          #<%= tag.name %>
        <% end %>
    </div>

    <% if user_signed_in? %>
    <div class="favorite-form-container">
      <%= render 'favorite_form' %>
    </div>
  <% end %>

  <% @locations.each_with_index do |location, idx| %>
  <h5>Location <%=idx + 1%></h5>
    <%= render partial: 'location_details', locals: { location: location } %>
    <% end %>

  <% if user_signed_in? %>
      <div class="attend-form-container">
        <%= render 'attend_form' %>
      </div>
  <% end %>

  <br>
  <h3>Tags</h3>
    <% @trip.tags.each do |tag| %>
      <div class="chip grey lighten-2">
        #<%= tag.name %>
      </div>
    <% end %>

  <div class="container comments-container">
    <h3>Comments: </h3>
    <% @trip.comments.each do |comment| %>
      <div class="comment-body">
        <blockquote>
        <p><%= comment.body %></p>
        <p>Commenter: <%= link_to comment.user.formatted_name %></p>
        <% if current_user == comment.user %>
          <%= link_to edit_comment_path(comment), class: "e-link" do %>
            <i class="tiny material-icons">mode_edit</i>
          <% end %>
          <%= form_for(comment, :html => { :method => :delete, class: "d-button"}) do |f| %>
            <%= hidden_field_tag "trip_id", "#{@trip.id}"  %>
            <%= button_tag(class: "delete-button") do %>
              <i class="tiny material-icons">delete</i>
            <% end %>
          <% end %>
        <% end %>
        </blockquote>
      </div>
    <% end %>
  </div>

  <% if user_signed_in? %>
    <div class="container new-comment-button">
      <%= form_for(@comment, url: new_comment_path, method: :get ) do |f| %>
        <%= hidden_field_tag "trip_id", "#{@trip.id}"  %>
        <%= f.submit "add comment", class: "waves-effect waves-light btn deep-orange" %>
      <% end %>
    </div>
  <% end %>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC8Bo_Dd2UfKD6HYbDmGNbCKy-pFivNcmw&libraries=places&callback=initMap"
  async defer></script>

<script>
  function initMap() {
    var map = new google.maps.Map(document.getElementById('trip-map'), {
      center: {lat: 40.712784, lng: -74.005941},
      zoom: 11,
    });

    $.ajax({
      url: window.location.href + '/locations.json'
    }).done( function( response ) {
      response.locations.map( function( location ) {
        var locationComponents = location.address.split( ' ' ).join( '+' )
        var contentString =
          '<div id="content">'+
            '<div id="siteNotice"></div>'+
            '<h5 id="firstHeading" class="firstHeading">'+
              location.name +
            '</h5>'+

            '<div id="bodyContent">'+
              '<p>'+ location.address +'</p>' +
              '<a href='+ 'https://www.google.com/maps/dir/Current+Location/' + locationComponents + ' target='+ '_blank' +'>Get Directions</a>'
            '</div>'+
          '</div>';

        var infowindow = new google.maps.InfoWindow({
          content: contentString
        });

        var marker = new google.maps.Marker({
          position: { lat: location.latitude, lng: location.longitude },
          map: map,
          title: 'Hello World'
        });
        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });
        map.addListener( 'click', function() {
          infowindow.close();
        });
      });
    }.bind( map ));
  };
</script>
